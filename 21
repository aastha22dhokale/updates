package com.ing.datadist.api.service;

import com.ing.datadist.api.model.*;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@Slf4j
public class UpdateOrganisationUnitService {
    private final OnePamRepository onePamRepository;

    public UpdateOrganisationUnitService(OnePamRepository onePamRepository){
        this.onePamRepository = onePamRepository;
    }

    public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper, SearchInvolvedPartiesResponseV1 response) throws Exception {

        String uuid = wrapper.getOpsUUID();
        List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits();


        for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) {
            List<SearchOrganisationUnitNameResponseV1> organisationUnitNames = organisationUnit.getOrganisationUnitNames();
            List<SearchOrganisationUnitAddressResponseV1> postalAddresses = organisationUnit.getPostalAddresses();
            List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses = organisationUnit.getDigitalAddresses();

            for (SearchOrganisationUnitNameResponseV1 name : organisationUnitNames) {
                if (Objects.equals(wrapper.getOrganisationUnitName(), name.getOrganisationUnitName())) {
                    log.info("Update organisationUnit name changed for uuid:{} old:{} new:{} ", uuid, wrapper.getOrganisationUnitName(), name.getOrganisationUnitName());
                    //Call update name API
                }
            }

            for (SearchOrganisationUnitAddressResponseV1 address : postalAddresses) {
                if (Objects.equals(wrapper.getPostalAddressStreetNm(), address.getStreetName())) {
                    log.info("Update organisationUnit StreetName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressStreetNm(), address.getStreetName());
                    //Call update postal addr API
                     onePamRepository.updatePostalAddress(wrapper, uuid, address.getStreetName());
                }

                if (Objects.equals(wrapper.getPostalAddressHouseNum(), address.getHouseNumber())) {
                    log.info("Update organisationUnit HouseNum changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseNum(), address.getHouseNumber());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getHouseNumber());
                }

                if (Objects.equals(wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition())) {
                    log.info("Update organisationUnit HouseAdd changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getHouseNumberAddition());
                }

                if (Objects.equals(wrapper.getPostalAddressPostalCd(), address.getPostalCode())) {
                    log.info("Update organisationUnit PostalCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressPostalCd(), address.getPostalCode());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getPostalCode());
                }

                if (Objects.equals(wrapper.getPostalAddressCityName(), address.getCityName())) {
                    log.info("Update organisationUnit CityName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCityName(), address.getCityName());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getCityName());
                }

                if (Objects.equals(wrapper.getPostalAddressCntryCd(), address.getCountryCode())) {
                    log.info("Update organisationUnit CountryCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCntryCd(), address.getCountryCode());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getCountryCode());
                }
            }

            for (SearchOrganisationUnitDigitalAddressesV1 digitalAddress : digitalAddresses) {
                if (Objects.equals(wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }

                if (Objects.equals(wrapper.getDigitalAddrFullTefgn(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrFullTefgn(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }

                if (Objects.equals(wrapper.getDigitalAddrFullTel(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrFullTel(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API
                }
            }

        }
    }
}
[INFO] 6 errors
[INFO] -------------------------------------------------------------
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  14.325 s
[INFO] Finished at: 2025-11-18T12:16:02+05:30
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.14.0:compile (default-compile) on project DataDistribution: Compilation failure: Compilation failure:
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[42,59] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[48,58] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[54,58] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[60,58] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[66,58] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] /C:/Users/UU47VT/dd-new/P33558-DataDistributorAPI/DataDistribution/src/main/java/com/ing/datadist/api/service/UpdateOrganisationUnitService.java:[72,58] incompatible types: com.ing.datadist.domain.OrganisationUnitDomainWrapper cannot be converted to com.ing.datadist.api.model.UpdatePostalAddressV5Request
[ERROR] -> [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException
PS C:\Users\UU47VT\dd-new\P33558-DataDistributorAPI\DataDistribution> 


    public CompletableFuture<UpdatePostalAddressV5Response> updatePostalAddress(
        UpdatePostalAddressV5Request payload, String uuid, String usageType){
    try {
        String url = RegkeyEnum.UPDATE_POSTAL_ADDRESS.resolveEndpoint(uuid, usageType);
        log.info("Updating Postal Address for UUID: {} with usageType: {}", uuid, usageType);

        Request request = new RichHttpRequestBuilder()
                .withUrl(url)
                .withMethod(Method.Patch())
                .withJsonContent(payload)
                .withHeader("X-ING-LastUpdateUser", "IN_ADMIN")
                .build();

        return apiClient.apply(request).thenApply(response -> {
            try {
                return objectMapper.readValue(response.contentString(), UpdatePostalAddressV5Response.class);
            } catch (Exception e) {
                throw new DataDistributionApiException(
                        RegkeyEnum.UPDATE_POSTAL_ADDRESS,
                        "Failed to parse response from updatePostalAddress API",
                        e.getMessage()
                );
            }
        });
    } catch (RichHttpRequestBuilderException e) {
        throw new DataDistributionApiException(
                RegkeyEnum.UPDATE_POSTAL_ADDRESS,
                "Failed to build request for updatePostalAddress API",
                e.getMessage()
        );
     }
    }

package com.ing.datadist.api.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.io.Serializable;

@Generated
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UpdatePostalAddressV5Response implements Serializable {
    private static final long serialVersionUID = 1L;

     @JsonProperty("postalAddress")
    private PostalAddressResponse postalAddress;

    @JsonProperty("_links")
    private InvolvedPartiesLinkSelfResponse links;
}


package com.ing.datadist.api.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.io.Serializable;

@Generated
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UpdatePostalAddressV5Request implements Serializable {
    private static final long serialVersionUID = 1L;

       @JsonProperty("lastVerificationDate")
    private String lastVerificationDate;

    @JsonProperty("endDate")
    private String endDate;

    @JsonProperty("deliveryFailureReasonType")
    private String deliveryFailureReasonType;
}

