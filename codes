package com.ing.datadist.api.service; import com.fasterxml.jackson.databind.ObjectMapper; import com.ing.apisdk.toolkit.connectivity.api.JavaService; import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilder; import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilderException; import com.ing.datadist.api.config.InvolvedPartyApiProperties; import com.ing.datadist.api.exception.DataDistributionApiException; import com.ing.datadist.api.model.*; import com.ing.datadist.api.utils.RegkeyEnum; import com.twitter.finagle.http.Method; import com.twitter.finagle.http.Request; import com.twitter.finagle.http.Response; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.stereotype.Component; import scala.collection.JavaConverters; import java.util.Map; import java.util.concurrent.CompletableFuture; @Slf4j @Component public class OnePamRepository { private final JavaService<Request, Response> apiClient; private final ObjectMapper objectMapper; private final InvolvedPartyApiProperties apiProperties; public OnePamRepository(@Qualifier("integrationServiceGeneric") JavaService<Request, Response> apiClient, ObjectMapper objectMapper, InvolvedPartyApiProperties apiProperties) { this.apiClient = apiClient; this.objectMapper = objectMapper; this.apiProperties = apiProperties; } public CompletableFuture<InvolvedPartiesOrganisationUnitResponse> createInvolvedParty(CreateOrganisationUnitRequest payload) { try { String url = RegkeyEnum.CREATE_INVOLVED_PARTY.endpoint; Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Post()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUse", "IN_ADMIN") .build(); return apiClient.apply(request) .thenApply(response -> { try { return objectMapper.readValue(response.contentString(), InvolvedPartiesOrganisationUnitResponse.class); } catch (Exception e) { throw new DataDistributionApiException( RegkeyEnum.CREATE_INVOLVED_PARTY, "Failed to parse response from Involved Party API", e.getMessage() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.CREATE_INVOLVED_PARTY, "Failed to build request for create involved party API", e.getMessage() ); } } public CompletableFuture<Void> updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest payload) { try { String url = RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER.resolveEndpoint(uuid); Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Post()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUse", "IN_ADMIN") .build(); return apiClient.apply(request) .thenApply(response -> { if (response.statusCode() >= 200 && response.statusCode() < 300) { return null; } else { throw new DataDistributionApiException( RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER, "Failed to update external identifier", "Status: " + response.statusCode() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER, "Failed to build request for update external identifier API", e.getMessage() ); } } public CompletableFuture<Void> createOrganisationUnitHierarchy(OrganisationUnitOrganisationRelationshipRequest payload) { try { String url = RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY.endpoint; Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Post()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUse", "IN_ADMIN") .build(); return apiClient.apply(request) .thenApply(response -> { if (response.statusCode() >= 200 && response.statusCode() < 300) { return null; } else { throw new DataDistributionApiException( RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY, "Failed to create organisation unit hierarchy", "Status: " + response.statusCode() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY, "Failed to build request for organisation unit hierarchy API", e.getMessage() ); } } public CompletableFuture<SearchInvolvedPartiesResponseV1> searchInvolvedPartyByInternalIdentifier(SearchInvolvedPartiesRequestV1 payload) { try { String url = RegkeyEnum.SEARCH_ORGANISATION_UNIT.endpoint;  // ✅ dynamically from enum log.info("searchInvolvedPartyByInternalIdentifier request payload: {}", payload); String jsonPayload = objectMapper.writeValueAsString(payload); Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Post()) .withJsonContent(jsonPayload) .withHeader("Content-Type", "application/json") .build(); printRequest(request); return apiClient.apply(request) .thenApply(response -> { try { log.info("searchInvolvedPartyByInternalIdentifier response: {}", response); return objectMapper.readValue(response.contentString(), SearchInvolvedPartiesResponseV1.class); } catch (Exception e) { log.error("searchInvolvedPartyByInternalIdentifier error: {}", e.getMessage()); throw new DataDistributionApiException( RegkeyEnum.SEARCH_ORGANISATION_UNIT, "Failed to parse response from search organisation unit API", e.getMessage() ); } }); } catch (Exception e) { log.error("searchInvolvedPartyByInternalIdentifier API error: {}", e.getMessage()); throw new DataDistributionApiException( RegkeyEnum.SEARCH_ORGANISATION_UNIT, "Failed to build request for search organisation unit API", e.getMessage() ); } } public CompletableFuture<UpdateOrganisationUnitNameV5Response> updateOrganisationUnitName( UpdateOrganisationUnitNameV5Request payload, String uuid, String nameType) { try { String url = RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME.resolveEndpoint(uuid, nameType); Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Patch()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser") .build(); return apiClient.apply(request) .thenApply(response -> { try { return objectMapper.readValue(response.contentString(), UpdateOrganisationUnitNameV5Response.class); } catch (Exception e) { throw new DataDistributionApiException( RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME, "Failed to parse response from updateOrganisationUnitName API", e.getMessage() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME, "Failed to build request for updateOrganisationUnitName API", e.getMessage() ); } } public CompletableFuture<UpdateInvolvedPartyResponseV5> updateInvolvedParty(UpdateInvolvedPartyRequestV5 payload, String uuid) { try { String url = RegkeyEnum.UPDATE_INVOLVED_PARTY.resolveEndpoint(uuid); Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Patch()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser") .build(); return apiClient.apply(request) .thenApply(response -> { try { return objectMapper.readValue(response.contentString(), UpdateInvolvedPartyResponseV5.class); } catch (Exception e) { throw new DataDistributionApiException( RegkeyEnum.UPDATE_INVOLVED_PARTY, "Failed to parse response for Update InvolvedParty Request API", e.getMessage() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.UPDATE_INVOLVED_PARTY, "Failed to build request for Update InvolvedParty Request API", e.getMessage() ); } } private static void printRequest(Request req) { try { log.info("----- Request Details -----"); log.info("Method: {}", req.method()); log.info("URI: {}", req.uri()); log.info("Version: {}", req.version()); Map<String, String> headerMap = JavaConverters.mapAsJavaMapConverter(req.headerMap()).asJava(); for (Map.Entry<String, String> entry : headerMap.entrySet()) { log.info("Header: {}: {}", entry.getKey(), entry.getValue()); } log.info("Body: {}", req.contentString()); log.info("---------------------------"); } catch (Exception e) { log.error("Exception while printing request", e); } } public CompletableFuture<Void> createPostalAddress(String uuid, CreatePostalAddressRequest payload) { try { String url = RegkeyEnum.CREATE_POSTAL_ADDRESS.resolveEndpoint(uuid); log.info("Calling OnePAM API to create postal address for UUID: {}", uuid); Request request = new RichHttpRequestBuilder() .withUrl(url) .withMethod(Method.Patch()) .withJsonContent(payload) .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser") .build(); return apiClient.apply(request) .thenApply(response -> { if (response.statusCode() >= 200 && response.statusCode() < 300) { log.info("Postal address created successfully for UUID: {}", uuid); return null; } else { log.error("Failed to create postal address. Status: {}", response.statusCode()); throw new DataDistributionApiException( RegkeyEnum.CREATE_POSTAL_ADDRESS, "Failed to create postal address", "Status: " + response.statusCode() ); } }); } catch (RichHttpRequestBuilderException e) { throw new DataDistributionApiException( RegkeyEnum.CREATE_POSTAL_ADDRESS, "Failed to build request for postal address creation", e.getMessage() ); } } } package com.ing.datadist.api.utils; import jakarta.ws.rs.HttpMethod; import lombok.Generated; import static org.apache.commons.lang3.StringUtils.SPACE; @Generated public enum RegkeyEnum { // ✅ OnePam endpoints CREATE_INVOLVED_PARTY("CREATE_INVOLVED_PARTY", HttpMethod.POST, "https://api.ing.com/v5/involved-parties"), UPDATE_EXTERNAL_IDENTIFIER("UPDATE_EXTERNAL_IDENTIFIER", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/external-identifiers"), CREATE_ORGANISATION_UNIT_HIERARCHY("CREATE_ORGANISATION_UNIT_HIERARCHY", HttpMethod.POST, "https://api.ing.com/v1/organisation-hierarchies/relationship"), SEARCH_ORGANISATION_UNIT("SEARCH_ORGANISATION_UNIT", HttpMethod.POST, "https://api.ing.com/v2/partyandagreementsearch/involved-parties/organisation-units/search"), UPDATE_INVOLVED_PARTY("UPDATE_INVOLVED_PARTY", HttpMethod.PATCH, "https://api.ing.com/v5/involved-parties/{uuid}"), CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP("CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP", HttpMethod.POST, "https://api.ing.com/v1/organisation-hierarchies/relationship/{uuid}/close"), UPDATE_ORGANISATION_UNIT_NAME("UPDATE_ORGANISATION_UNIT_NAME", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/organisation-unit-names "), CREATE_POSTAL_ADDRESS("CREATE_POSTAL_ADDRESS", HttpMethod.POST, "https://api.ing.com/v5/involved-parties/{uuid}/postal-addresses"); public final String label; public final String method; public final String endpoint; RegkeyEnum(String label, String method, String endpoint) { this.label = label; this.method = method; this.endpoint = endpoint; } /** * Dynamically replaces path variables like {uuid} with actual values. */ public String resolveEndpoint(String... values) { String resolved = endpoint; for (String value : values) { resolved = resolved.replaceFirst("\\{[^}]+}", value); } return resolved; } @Override public String toString() { return label + " || " + method + SPACE + endpoint; } } package com.ing.datadist.api.model; import com.fasterxml.jackson.annotation.JsonInclude; import com.fasterxml.jackson.annotation.JsonProperty; import lombok.*; import java.util.List; @Generated @Data @Builder @NoArgsConstructor @AllArgsConstructor @JsonInclude(JsonInclude.Include.NON_EMPTY) public class CreateOrganisationUnitRequest { @JsonProperty("dataSource") private String dataSource; @JsonProperty("logicalDataDomain") private String logicalDataDomain; @JsonProperty("countryOfResidence") private String countryOfResidence; @JsonProperty("preferredLanguage") private String preferredLanguage; @JsonProperty("financialLegalStatusType") private String financialLegalStatusType; @JsonProperty("channelOfEntry") private String channelOfEntry; @JsonProperty("effectiveDate") private String effectiveDate; @JsonProperty("endDate") private String endDate; @JsonProperty("organisationUnitStructureType") private String organisationUnitStructureType; @JsonProperty("organisationUnitNames") private List<CreateOrganisationUnitNameRequest> organisationUnitNames; @JsonProperty("involvedPartyInternalIdentifiers") private List<CreateInternalIdentifierRequest> involvedPartyInternalIdentifiers; } package com.ing.datadist.api.model; import com.fasterxml.jackson.annotation.JsonProperty; import lombok.*; import java.io.Serializable; @Data @Builder @NoArgsConstructor @AllArgsConstructor @Generated public class DigitalAddressResponse implements Serializable { private static final long serialVersionUID = 1L; @JsonProperty("digitalAddressType") private String digitalAddressType; @JsonProperty("digitalAddressUsageType") private String digitalAddressUsageType; @JsonProperty("fullDigitalAddress") private String fullDigitalAddress; @JsonProperty("deliveryFailureReasonType") private String deliveryFailureReasonType; @JsonProperty("dataSource") private String dataSource; @JsonProperty("effectiveDate") private String effectiveDate; @JsonProperty("endDate") private String endDate; @JsonProperty("lastUpdateUser") private String lastUpdateUser; @JsonProperty("lastUpdateDate") private String lastUpdateDate; } package com.ing.datadist.api.model; import com.fasterxml.jackson.annotation.JsonProperty; import lombok.*; import java.io.Serializable; @Data @NoArgsConstructor @AllArgsConstructor @Builder @Generated public class PostalAddressResponse implements Serializable { private static final long serialVersionUID = 1L; @JsonProperty("postalAddressUsageType") private String postalAddressUsageType; @JsonProperty("countryCode") private String countryCode; @JsonProperty("countryRegionCode") private String countryRegionCode; @JsonProperty("districtName") private String districtName; @JsonProperty("cityName") private String cityName; @JsonProperty("cityAreaName") private String cityAreaName; @JsonProperty("regionName") private String regionName; @JsonProperty("postalCode") private String postalCode; @JsonProperty("streetName") private String streetName; @JsonProperty("houseNumber") private String houseNumber; @JsonProperty("houseNumberAddition") private String houseNumberAddition; @JsonProperty("buildingName") private String buildingName; @JsonProperty("deliveryInformation") private String deliveryInformation; @JsonProperty("floor") private String floor; @JsonProperty("locationUnitNumber") private String locationUnitNumber; @JsonProperty("departmentName") private String departmentName; @JsonProperty("subdepartmentName") private String subdepartmentName; @JsonProperty("poBoxNumber") private String poBoxNumber; @JsonProperty("streetType") private String streetType; @JsonProperty("unstructuredAddressLine1") private String unstructuredAddressLine1; @JsonProperty("unstructuredAddressLine2") private String unstructuredAddressLine2; @JsonProperty("unstructuredAddressLine3") private String unstructuredAddressLine3; @JsonProperty("deliveryFailureReasonType") private String deliveryFailureReasonType; @JsonProperty("dataSource") private String dataSource; @JsonProperty("lastUpdateUser") private String lastUpdateUser; @JsonProperty("lastUpdateDate") private String lastUpdateDate; @JsonProperty("effectiveDate") private String effectiveDate; @JsonProperty("lastVerificationDate") private String lastVerificationDate; @JsonProperty("endDate") private String endDate; }
