package com.ing.datadist.api.service;

import com.ing.datadist.api.model.*;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;

@Service
@Slf4j
public class UpdateOrganisationUnitService {
    private final OnePamRepository onePamRepository;

    public UpdateOrganisationUnitService(OnePamRepository onePamRepository){
        this.onePamRepository = onePamRepository;
    }

    public void updateOrganisationUnit(OrganisationUnitDomainWrapper wrapper, SearchInvolvedPartiesResponseV1 response) throws Exception {

        String uuid = wrapper.getOpsUUID();
        List<SearchOrganisationUnitResponseV1> organisationUnits = response.getOrganisationUnits();

        for (SearchOrganisationUnitResponseV1 organisationUnit : organisationUnits) {
            List<SearchOrganisationUnitNameResponseV1> organisationUnitNames = organisationUnit.getOrganisationUnitNames();
            List<SearchOrganisationUnitAddressResponseV1> postalAddresses = organisationUnit.getPostalAddresses();
            List<SearchOrganisationUnitDigitalAddressesV1> digitalAddresses = organisationUnit.getDigitalAddresses();

            for (SearchOrganisationUnitNameResponseV1 name : organisationUnitNames) {
                if (Objects.equals(wrapper.getOrganisationUnitName(), name.getOrganisationUnitName())) {
                    log.info("Update organisationUnit name changed for uuid:{} old:{} new:{} ", uuid, wrapper.getOrganisationUnitName(), name.getOrganisationUnitName());
                    //Call update name API
                }
            }

            for (SearchOrganisationUnitAddressResponseV1 address : postalAddresses) {
                if (Objects.equals(wrapper.getPostalAddressStreetNm(), address.getStreetName())) {
                    log.info("Update organisationUnit StreetName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressStreetNm(), address.getStreetName());
                    //Call update postal addr API
                     onePamRepository.updatePostalAddress(wrapper, uuid, address.getStreetName());
                }

                if (Objects.equals(wrapper.getPostalAddressHouseNum(), address.getHouseNumber())) {
                    log.info("Update organisationUnit HouseNum changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseNum(), address.getHouseNumber());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getHouseNumber());
                }

                if (Objects.equals(wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition())) {
                    log.info("Update organisationUnit HouseAdd changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressHouseAdd(), address.getHouseNumberAddition());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getHouseNumberAddition());
                }

                if (Objects.equals(wrapper.getPostalAddressPostalCd(), address.getPostalCode())) {
                    log.info("Update organisationUnit PostalCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressPostalCd(), address.getPostalCode());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getPostalCode());
                }

                if (Objects.equals(wrapper.getPostalAddressCityName(), address.getCityName())) {
                    log.info("Update organisationUnit CityName changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCityName(), address.getCityName());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getCityName());
                }

                if (Objects.equals(wrapper.getPostalAddressCntryCd(), address.getCountryCode())) {
                    log.info("Update organisationUnit CountryCode changed for uuid:{} old:{} new:{} ", uuid, wrapper.getPostalAddressCntryCd(), address.getCountryCode());
                    //Call update postal addr API
                    onePamRepository.updatePostalAddress(wrapper, uuid, address.getCountryCode());
                }
            }

            for (SearchOrganisationUnitDigitalAddressesV1 digitalAddress : digitalAddresses) {
                if (Objects.equals(wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress())) {
                    log.info("Update organisationUnit FullDigitalAddress changed for uuid:{} old:{} new:{} ", uuid, wrapper.getDigitalAddrEmail(), digitalAddress.getFullDigitalAddress());
                    //Call update digital addr API

                }
            }

        }
    }
}

package com.ing.datadist.api.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.ing.apisdk.toolkit.connectivity.api.JavaService;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilder;
import com.ing.apisdk.toolkit.connectivity.transport.http.japi.RichHttpRequestBuilderException;

import com.ing.datadist.api.config.InvolvedPartyApiProperties;
import com.ing.datadist.api.exception.DataDistributionApiException;
import com.ing.datadist.api.model.*;
import com.ing.datadist.api.utils.RegkeyEnum;
import com.twitter.finagle.http.Method;
import com.twitter.finagle.http.Request;
import com.twitter.finagle.http.Response;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import scala.collection.JavaConverters;

import java.util.Map;

import java.util.concurrent.CompletableFuture;

@Slf4j
@Component
public class OnePamRepository {

    private final JavaService<Request, Response> apiClient;
    private final ObjectMapper objectMapper;
    private final InvolvedPartyApiProperties apiProperties;

    public OnePamRepository(@Qualifier("integrationServiceGeneric") JavaService<Request, Response> apiClient,
                            ObjectMapper objectMapper,
                            InvolvedPartyApiProperties apiProperties) {
        this.apiClient = apiClient;
        this.objectMapper = objectMapper;
        this.apiProperties = apiProperties;
    }

    public CompletableFuture<InvolvedPartiesOrganisationUnitResponse> createInvolvedParty(CreateOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_INVOLVED_PARTY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), InvolvedPartiesOrganisationUnitResponse.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                                    "Failed to parse response from Involved Party API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_INVOLVED_PARTY,
                    "Failed to build request for create involved party API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<Void> updateExternalIdentifier(String uuid, UpdateExternalIdentifierOrganisationUnitRequest payload) {
        try {
            String url = RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                                    "Failed to update external identifier",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_EXTERNAL_IDENTIFIER,
                    "Failed to build request for update external identifier API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<Void> createOrganisationUnitHierarchy(OrganisationUnitOrganisationRelationshipRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY.endpoint;
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUse", "IN_ADMIN")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            return null;
                        } else {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                                    "Failed to create organisation unit hierarchy",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_ORGANISATION_UNIT_HIERARCHY,
                    "Failed to build request for organisation unit hierarchy API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<SearchInvolvedPartiesResponseV1> searchInvolvedPartyByInternalIdentifier(SearchInvolvedPartiesRequestV1 payload) {
        try {
            String url = RegkeyEnum.SEARCH_ORGANISATION_UNIT.endpoint;  // ‚úÖ dynamically from enum
            log.info("searchInvolvedPartyByInternalIdentifier request payload: {}", payload);
            String jsonPayload = objectMapper.writeValueAsString(payload);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withJsonContent(jsonPayload)
                    .withHeader("Content-Type", "application/json")
                    .build();
            printRequest(request);
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            log.info("searchInvolvedPartyByInternalIdentifier response: {}", response);
                            return objectMapper.readValue(response.contentString(), SearchInvolvedPartiesResponseV1.class);
                        } catch (Exception e) {
                            log.error("searchInvolvedPartyByInternalIdentifier error: {}", e.getMessage());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                                    "Failed to parse response from search organisation unit API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (Exception e) {
            log.error("searchInvolvedPartyByInternalIdentifier API error: {}", e.getMessage());
            throw new DataDistributionApiException(
                    RegkeyEnum.SEARCH_ORGANISATION_UNIT,
                    "Failed to build request for search organisation unit API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateOrganisationUnitNameV5Response> updateOrganisationUnitName(
            UpdateOrganisationUnitNameV5Request payload, String uuid, String nameType) {
        try {
            String url = RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME.resolveEndpoint(uuid, nameType);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateOrganisationUnitNameV5Response.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                                    "Failed to parse response from updateOrganisationUnitName API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_ORGANISATION_UNIT_NAME,
                    "Failed to build request for updateOrganisationUnitName API",
                    e.getMessage()
            );
        }
    }

    public CompletableFuture<UpdateInvolvedPartyResponseV5> updateInvolvedParty(UpdateInvolvedPartyRequestV5 payload, String uuid) {
        try {
            String url = RegkeyEnum.UPDATE_INVOLVED_PARTY.resolveEndpoint(uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        try {
                            return objectMapper.readValue(response.contentString(), UpdateInvolvedPartyResponseV5.class);
                        } catch (Exception e) {
                            throw new DataDistributionApiException(
                                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                                    "Failed to parse response for Update InvolvedParty Request API",
                                    e.getMessage()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_INVOLVED_PARTY,
                    "Failed to build request for Update InvolvedParty Request API",
                    e.getMessage()
            );
        }
    }

    private static void printRequest(Request req) {
        try {
            log.info("----- Request Details -----");
            log.info("Method: {}", req.method());
            log.info("URI: {}", req.uri());
            log.info("Version: {}", req.version());
            Map<String, String> headerMap = JavaConverters.mapAsJavaMapConverter(req.headerMap()).asJava();
            for (Map.Entry<String, String> entry : headerMap.entrySet()) {
                log.info("Header: {}: {}", entry.getKey(), entry.getValue());
            }
            log.info("Body: {}", req.contentString());
            log.info("---------------------------");
        } catch (Exception e) {
            log.error("Exception while printing request", e);
        }
    }

    public CompletableFuture<Void> createPostalAddress(String uuid, CreatePostalAddressRequest payload) {
        try {
            String url = RegkeyEnum.CREATE_POSTAL_ADDRESS.resolveEndpoint(uuid);
            log.info("Calling OnePAM API to create postal address for UUID: {}", uuid);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "X-ING-LastUpdateUser")
                    .build();
            return apiClient.apply(request)
                    .thenApply(response -> {
                        if (response.statusCode() >= 200 && response.statusCode() < 300) {
                            log.info("Postal address created successfully for UUID: {}", uuid);
                            return null;
                        } else {
                            log.error("Failed to create postal address. Status: {}", response.statusCode());
                            throw new DataDistributionApiException(
                                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                                    "Failed to create postal address",
                                    "Status: " + response.statusCode()
                            );
                        }
                    });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.CREATE_POSTAL_ADDRESS,
                    "Failed to build request for postal address creation",
                    e.getMessage()
            );
        }
    }

    //fixme need fetch the even OrganisationUnitHierarchy uuid from Accounting table later
    public OrganisationUnitOrganisationRelationshipResponse closeOrganisationHierarchyRelationship(String uuid) {
        try {
//            String url = apiProperties.getUrl() + "/v1/organisation-hierarchies/relationship/" + uuid + "/close";
            String url = RegkeyEnum.CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP.resolveEndpoint(uuid);
            log.info("Closing Organisation Hierarchy Relationship");
            log.info("Request URL: {}", url);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Post())
                    .withHeader("X-ING-LastUpdateUser", "IN_ADMIN")
                    .build();
            printRequest(request);
            Response response = apiClient.apply(request).get();
            log.info("Response Status: {}", response.statusCode());
            log.info("Response Body: {}", response.contentString());
            if (response.statusCode() >= 200) {
                ObjectMapper mapper = new ObjectMapper();
                return mapper.readValue(response.contentString(), OrganisationUnitOrganisationRelationshipResponse.class);
            } else {
                throw new DataDistributionApiException(
                        RegkeyEnum.CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP,
                        "Failed to close relationship",
                        "Status: " + response.statusCode()
                );
            }
        } catch (Exception e) {
            log.error("Exception while closing Organisation Hierarchy Relationship for uuid={}", uuid, e);
            throw new DataDistributionApiException(
                    RegkeyEnum.CLOSE_ORGANISATION_HIERARCHY_RELATIONSHIP,
                    "Error during closing organisation hierarchy relationship",
                    e.getMessage()
            );
        }

    }
    /**
     * Overload to support service calling with OrganisationUnitDomainWrapper.
     * Builds the UpdatePostalAddressV5Request inside the repository (manager requested
     * to use the example constants for now), calls OnePAM and returns the parsed response.
     *
     * Signature chosen to match existing UpdateOrganisationUnitService calls:
     *     onePamRepository.updatePostalAddress(wrapper, uuid, usageType);
     */
    public CompletableFuture<UpdatePostalAddressV5Response> updatePostalAddress(
            com.ing.datadist.domain.OrganisationUnitDomainWrapper wrapper,
            String uuid,
            String usageType) {
        try {
            // Manager requested to use example constants for now (will be replaced later)
            UpdatePostalAddressV5Request payload = UpdatePostalAddressV5Request.builder()
                    .lastVerificationDate("2023-05-03T10:11:12.999Z")
                    .endDate("2050-12-12T23:59:59.999+02:00")
                    .deliveryFailureReasonType("ADR_NOT_EXST")
                    .build();
            String url = RegkeyEnum.UPDATE_POSTAL_ADDRESS.resolveEndpoint(uuid, usageType);
            log.info("Updating Postal Address (wrapper overload) for UUID: {} usageType: {}", uuid, usageType);
            Request request = new RichHttpRequestBuilder()
                    .withUrl(url)
                    .withMethod(Method.Patch())
                    .withJsonContent(payload)
                    .withHeader("X-ING-LastUpdateUser", "IN_ADMIN")
                    .build();
            return apiClient.apply(request).thenApply(response -> {
                try {
                    return objectMapper.readValue(response.contentString(), UpdatePostalAddressV5Response.class);
                } catch (Exception e) {
                    throw new DataDistributionApiException(
                            RegkeyEnum.UPDATE_POSTAL_ADDRESS,
                            "Failed to parse response from updatePostalAddress API",
                            e.getMessage()
                    );
                }
            });
        } catch (RichHttpRequestBuilderException e) {
            throw new DataDistributionApiException(
                    RegkeyEnum.UPDATE_POSTAL_ADDRESS,
                    "Failed to build request for updatePostalAddress API",
                    e.getMessage()
            );
        }
    }

}

Subscribe
OpenApiDocument
P00007
OAS 3
Involved Party API

Share
View in Console
Back to API details
DEPRECATED - Update a digital address for the party identified by the usage type.
patch
/v5/involved-parties/{uuid}/digital-addresses/{usageType}

‚ö†Ô∏è This operation is deprecated

üè∑Ô∏è DigitalAddresses, Deprecated

DEPRECATED - Update a digital address for the party identified by the usage type.

header params
X-ING-LastUpdateUser string required
The LastUpdateUser

path params
uuid string required
UUID of an Involved Party.

usageType string required
Usage type of the digital address to update

Request body (required)
The body should contain the fields you wish to update


application/json

Schema
Examples
‚ñæ
object required
fullDigitalAddress string
The fullDigitalAddress of the digitalAddress.

example: hello@ing.com
deliveryFailureReasonType string
The deliveryFailureReasonType of the digitalAddress.

example: ADR_NOT_EXST
dataSource string
The dataSource of the digitalAddress.

example: FOS_IT
effectiveDate string
The effective date

example: 2020-10-10T10:11:12.345+02:00
endDate string
The end date

example: 2050-12-12T23:59:59.999+02:00
Responses

200

400

404

500
200 OK


application/json

Schema
Examples
‚ñæ
object
‚ñæ
digitalAddress object
digitalAddressType string
example: EMAIL_ADR
digitalAddressUsageType string
example: PSN_EMAIL
fullDigitalAddress string
example: hello@ing.com
deliveryFailureReasonType string
example: ADR_NOT_EXST
dataSource string
example: FOS_IT
effectiveDate string
The effective date

example: 2020-10-10T08:11:12.345Z
endDate string
The end date

example: 2050-12-12T21:59:59.999Z
lastUpdateUser string
example: OnePam
lastUpdateDate string
example: 2021-04-27T09:11:11.111Z
‚ñ∏
_links object
